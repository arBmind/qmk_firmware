#include QMK_KEYBOARD_H
#include <ch.h>
#include <hal.h>
#include <string.h>
#include "eeconfig.h"
#include "serial_link/system/serial_link.h"

void ergodox_infinity_lcd_color(uint16_t r, uint16_t g, uint16_t b);

// static void format_layer_bitmap_string(char* buffer, uint8_t offset) {
//     for (int i = 0; i < 16 && i + offset < MAX_LAYER; i++) {
//         if (i == 0 || i == 4 || i == 8 || i == 12) {
//             *buffer = ' ';
//             ++buffer;
//         }

//         uint8_t layer = i + offset;
//         if (layer_state_cmp(default_layer_state, layer)) {
//             *buffer = 'D';
//         } else if (layer_state_is(layer)) {
//             *buffer = '1';
//         } else {
//             *buffer = '_';
//         }
//         ++buffer;
//     }
//     *buffer = 0;
// }

typedef struct lcd_color_t {
  uint16_t red;
  uint16_t green;
  uint16_t blue;
} lcd_color_t;

void st7565_task_user(void) {
    // if (is_keyboard_master()) {
    //     // Draw led and layer status
    //     led_t leds = host_keyboard_led_state();
    //     if(leds.num_lock) { st7565_write("Num ", false); }
    //     if(leds.caps_lock) { st7565_write("Cap ", false); }
    //     if(leds.scroll_lock) { st7565_write("Scrl ", false); }
    //     if(leds.compose) { st7565_write("Com ", false); }
    //     if(leds.kana) { st7565_write("Kana", false); }
    //     st7565_advance_page(true);

    //     char layer_buffer[16 + 5];  // 3 spaces and one null terminator
    //     st7565_set_cursor(0, 1);
    //     format_layer_bitmap_string(layer_buffer, 0);
    //     st7565_write_ln(layer_buffer, false);
    //     format_layer_bitmap_string(layer_buffer, 16);
    //     st7565_write_ln(layer_buffer, false);
    //     st7565_write_ln("  1=On    D=Default", false);
    // } else {

      lcd_color_t lcd_color = { 0, 0, 0 };
      lcd_color_t on_color = { UINT16_MAX / 2, UINT16_MAX / 2, UINT16_MAX / 2 };
      lcd_color_t greenish = { UINT16_MAX, UINT16_MAX / 2, UINT16_MAX / 2 };
      lcd_color_t redish = { UINT16_MAX / 2, UINT16_MAX, UINT16_MAX / 2 };
      lcd_color_t blueish = { UINT16_MAX / 2, UINT16_MAX / 2, UINT16_MAX };
      lcd_color_t violet = { UINT16_MAX, UINT16_MAX / 2, UINT16_MAX };
      lcd_color_t yellowish = { UINT16_MAX, UINT16_MAX, UINT16_MAX / 2 };
      if (st7565_is_on()) {
        lcd_color = on_color;

        // Draw logo
        static const char resource_lcd_logo[512] = {
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x10, 0x10, 0x18, 0x18, 0x18, 0x18, 0x1c, 0x1c, 0x0c, 0x0c,
          0x0c, 0x0c, 0xcc, 0xdc, 0xdc, 0xfc, 0xfc, 0xfc, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8, 0xf0, 0xf0, 0xf0,
          0xe0, 0xe0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x70, 0x70, 0xf8, 0xf8, 0x70, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0,
          0xe0, 0xf0, 0xf8, 0xf8, 0x7c, 0x3c, 0x3c, 0x3c, 0x7c, 0xfc, 0xfc, 0xf8, 0xf8, 0xe0, 0x00, 0x00,
          0x00, 0x00, 0x00, 0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0x60, 0x30, 0x38, 0xfc, 0xfc, 0xfc, 0xfc, 0xf8,
          0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xff, 0xff, 0x7f,
          0x7f, 0x3f, 0x1f, 0x00, 0x00, 0x00, 0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0x60, 0x30, 0x38, 0xfc, 0xfc,
          0xfc, 0xfc, 0xf8, 0x60, 0x30, 0x38, 0x3c, 0xfc, 0xfc, 0xfc, 0xfc, 0xf8, 0x00, 0x00, 0x30, 0x38,
          0x38, 0x3c, 0x3c, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0x60, 0x30, 0x38, 0x3c, 0xfc, 0xfc, 0xfc, 0xfc, 0xf8, 0x00, 0x00,
          0x00, 0x00, 0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0x7c, 0x3c, 0x3c, 0x3c, 0xff, 0xff, 0xff, 0xff, 0xff,
          0xf0, 0xf8, 0xfc, 0xfc, 0x9c, 0x1c, 0x1c, 0x1c, 0x1c, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00,
          0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03,
          0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x87, 0xff, 0xff,
          0xff, 0xfe, 0xfc, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff,
          0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00,
          0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff,
          0x03, 0x07, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x07, 0x03, 0x03, 0x07, 0x0f, 0x0f, 0x0f, 0x0f,
          0x0e, 0x00, 0x00, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x30, 0x30,
          0x30, 0x30, 0x33, 0x3b, 0x3b, 0x3f, 0x3f, 0x3f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x0f, 0x0f, 0x0f,
          0x07, 0x07, 0x03, 0x00, 0x00, 0x00, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x00, 0x00, 0x00, 0x0f, 0x0f,
          0x0f, 0x0f, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x00, 0x00, 0x0f, 0x0f,
          0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x00, 0x00, 0x00,
          0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x00, 0x00,
          0x00, 0x00, 0x03, 0x07, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x07, 0x03, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f
        };
        st7565_write_raw(resource_lcd_logo, 512);
        st7565_set_cursor(0, 0);

        // default layer
        if (layer_state_cmp(default_layer_state, 1)) {
          st7565_write("game", false);
          lcd_color = yellowish;
        }
        else if (layer_state_cmp(default_layer_state, 2)) {
          st7565_write("bone", false);
          lcd_color = blueish;
        }
        else {
          st7565_write("qwer", false);
        }

        // colors for layers
        if (layer_state_is(3)) {
          lcd_color = greenish;
        }
        else if (layer_state_is(4)) {
          lcd_color = redish;
        }
        else if (layer_state_is(5)) {
          lcd_color = violet;
        }
      }
      ergodox_infinity_lcd_color(lcd_color.red, lcd_color.green, lcd_color.blue);
    // }
}
